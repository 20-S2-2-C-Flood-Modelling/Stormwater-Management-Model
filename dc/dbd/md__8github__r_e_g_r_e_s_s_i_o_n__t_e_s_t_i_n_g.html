<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SWMM-Docs: SWMM Regression Testing</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SWMM-Docs
   &#160;<span id="projectnumber">5.2.0.dev5</span>
   </div>
   <div id="projectbrief">Stormwater Management Model</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">SWMM Regression Testing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Prerequisits</h2>
<p>Running SWMM's regression test suite <code>swmm-nrtestsuite</code> requires installation of the following software.</p><ul>
<li>git</li>
<li>C compiler - MSVC, gcc, xcode</li>
<li>cmake</li>
<li>python 2.7 including setup tools</li>
<li>swig</li>
</ul>
<h2>Step by Step Guide for Linux and MacOS</h2>
<p>The following are step by step instructions to compare the current SWMM OWA build against the SWMM 5.1.12 MSVC 32 bit benchmark.</p>
<ol type="1">
<li>Clone the swmm github repository. <div class="fragment"><div class="line">$ git clone --branch=develop https://github.com/OpenWaterAnalytics/Stormwater-Management-Model.git</div></div><!-- fragment --></li>
<li>Make repository root the current working directory <div class="fragment"><div class="line">$ cd Stormwater-Management-Model</div></div><!-- fragment --></li>
<li>Build swmm using cmake. <div class="fragment"><div class="line">$ cd buildprod</div><div class="line">$ cmake -DCMAKE_BUILD_TYPE=Release ..</div><div class="line">$ cmake --build . --config Release</div></div><!-- fragment --></li>
<li>Install the required python packages. <div class="fragment"><div class="line">$ pip install -r tools/requirements.txt </div></div><!-- fragment --></li>
<li>Configure and run the regression tests: where &lt;build id&gt;=""&gt; - is the build identifier (i.e. swmm version number). <div class="fragment"><div class="line">$ cd ..</div><div class="line">$ tools/before-test.sh nrtestsuite `pwd`/buildprod/bin &lt;build id&gt;</div><div class="line">$ tools/run-nrtest.sh nrtestsuite &lt;build id&gt;</div></div><!-- fragment --></li>
</ol>
<h2>Step by Step Guide for Windows</h2>
<p>Coming soon ...</p>
<h2>Working with nrtest</h2>
<p>Using <code>nrtest</code> it is possible to compare any two versions of SWMM as long as they share the same binary file format. <code>nrtest</code> comes with a python scripts for running its <code>execute</code> and <code>compare</code> commands. </p><div class="fragment"><div class="line">$ python nrtest execute apps/&lt;app.json&gt; tests/&lt;test.json&gt; -o benchmark/</div><div class="line">$ python nrtest compare test_benchmark/ ref_benchmark/ --rtol --atol</div></div><!-- fragment --><p><b>To what values should rtol and atol be set?</b></p>
<p>What appears to be a simple question on the surface turns out to be more difficult upon deeper examination. The numpy testing assert allclose comparison criteria leaves a lot to be desired from a theoretical perspective, however, I have found it useful when evaluating differences between versions of SWMM.</p>
<p>For those wishing to dig into the details I found the linked <a href="https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/">blog post</a> to be a useful starting point.</p>
<p>For both nrtest execute and nrtest compare non-zero exit codes are returned on failure.</p>
<p>More information on nrtest is available in the nrtest <a href="https://nrtest.readthedocs.io/en/latest/">docs</a>.</p>
<h2>Extending the Testsuite</h2>
<p><b>Where did the test and benchmark files go?</b></p>
<p>The test and benchmark files are kept in a seperate <a href="https://github.com/OpenWaterAnalytics/swmm-example-networks">repo</a>. The script before-test.sh has been provided to retreive and stage the needed files for testing.</p>
<p><b>How to add a new or different version of SWMM?</b></p>
<p>nrtest runs the command line execuatable version of SWMM for testing purposes. To add a new or different version of SWMM for benchmarking a json file that contains the absolute path to the executable location and some meta-data describing it needs to be created. See the nrtest documentation for details. The executable and the json file need to be copied to their designated locations.</p>
<p><b>How to add a test?</b></p>
<p>To add a new test the [REPORTS] section of the input file should be configured to write all results out to the binary file. A json file also needs to be created that describes how to execute the test, what files are needed, what files get generated, what comparison routines to use, and meta-data describing the test. The format and data found in the json files is resonably well described in the nrtest documentation. The input file, any auxiliary file need to run the test, and the json file describing the test should be added to the swmm-tests folder found in the swmm-example-networks repo. Finally, the test needs to be added to run-nrtest.sh so it gets called and run.</p>
<p><b>How to add a new comparison routine?</b></p>
<p>New comparison criteria can easily be implemented in the nrtest_swmm package. The package nrtest uses setup entrypoints as a simple plugin mechanism for finding comparison routines at runtime. New comparison routines can be added as a function with the swmm_xxxxxxx_compare() name pattern. The function also needs to be declared as an entry point in the nrtest_swmm setup.py file.</p>
<p>A basic comparison function is also provided for checking the contents of report files. It can easily be adapted for testing other types of text based files.</p>
<h2>Common Problems</h2>
<p>When adding new apps and tests the json format can be a bit finicky and json parsing errors aren't being reported in a user friendly manner.</p>
<p>The absolute path to the executable must be specified in the json file describing the application for testing.</p>
<p>SWMM requires the absolute path of data files referenced in a SWMM input file (e.g. rain gauge data).</p>
<p>The packages swmm_output and nrtest_swmm were developed and run on Windows with 64 bit version of Python 2.7. They have not been tested on Mac OS or Linux systems and have not been run using Python 3.</p>
<p>Unfortunately, nrtest_swmm is slow. For example comparing two 500 MB files takes on the order of 20 minutes. Therefore, tests when added should generate small output files. If your system is running a test and appears to be doing nothing it might be bogged down comparing large binary files. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
